# Prepares a system to be a hypervsior and sets up the hosts group 'guests' as kvm guests
# Jamie Duncan

- name: ensure kvm is installed and started
  service: name=libvirtd state=started enabled=yes
  register: libvirtd

- name: wait for libvirtd to start up
  pause: seconds=30
  when: libvirtd.changed

- name: ensure libguestfs-tools is installed
  yum: name=libguestfs-tools state=latest

- name: create workspace folder
  file: name={{ tmp_workspace }} state=directory

- name: add ssh public key to hypervisor for hosts
  copy: src={{ ssh_key }} dest={{ tmp_workspace }}/ssh_key.pub

- name: create hosts file for hypervisor
  template: src=../templates/hosts dest=/etc/hosts

- name: create tmp hosts file for image customization
  template: src=../templates/hosts dest={{ tmp_workspace }}/hosts

- name: Copy over the virtual disk images
  copy: src={{ guest_image }} dest={{ kvm_disk_dir }}/{{ hostvars[item]['inventory_hostname'] }}.qcow2
  with_items: groups['guests']

- name: create temporary folder for host disk customization
  file: name={{ tmp_workspace }}/{{ hostvars[item]['inventory_hostname'] }} state=directory
  with_items: groups['guests']

- name: create ifcfg files for each server
  template: src=../templates/ifcfg-eth0 dest={{ tmp_workspace }}/{{ hostvars[item]['inventory_hostname'] }}/ifcfg-eth0
  with_items: groups['guests']

- name: Customize the virtual disk images
  command: virt-customize -a {{ kvm_disk_dir }}/{{ hostvars[item]['inventory_hostname'] }}.qcow2
           --hostname {{ hostvars[item]['inventory_hostname'] }}
           --root-password password:{{ root_password }}
           --ssh-inject root:file:{{ tmp_workspace }}/ssh_key.pub
           --upload {{ tmp_workspace }}/{{ hostvars[item]['inventory_hostname'] }}/ifcfg-eth0:/etc/sysconfig/network-scripts/
           --upload {{ tmp_workspace }}/hosts:/etc/hosts
           --run-command 'systemctl disable cloud-init'
           --firstboot-command 'systemctl stop cloud-init'
           --firstboot-command 'restorecon -R /root/.ssh'
  with_items: groups['guests']

- name: Define guest images
  virt: name={{ hostvars[item]['inventory_hostname'] }}
        command=define
        xml="{{ lookup('template', '../templates/vm.xml') }}"
        uri=qemu:///system
  with_items: groups['guests']

- name: Start the new Virtual Machines
  virt:  name={{ hostvars[item]['inventory_hostname'] }}
         command=start
         uri=qemu:///system
  with_items: groups['guests']

- name: make sure all vms are running
  local_action: wait_for host={{ hostvars[item]['inventory_hostname'] }} port=22 state=started delay=5 timeout=15
  sudo: false
  with_items: groups['guests']

- name: make sure the known_hosts file exists
  file: path={{ ssh_known_hosts_file }} state=touch

- name: remove any stale entries for these virtual Machines by hostname
  shell: "ssh-keygen -R {{ hostvars[item]['inventory_hostname'] }} -f {{ ssh_known_hosts_file}}"
  with_items: groups['guests']

- name: remove any stale entries for these virtual Machines by ip
  shell: "ssh-keygen -R {{ hostvars[item]['ip'] }} -f {{ ssh_known_hosts_file}}"
  with_items: groups['guests']

- name: add the new ssh host keys by hostname
  shell: "ssh-keyscan {{ hostvars[item]['inventory_hostname'] }} >> {{ ssh_known_hosts_file }}"
  with_items: groups['guests']

- name: add the new ssh host keys by ip
  shell: "ssh-keyscan {{ hostvars[item]['ip'] }} >> {{ ssh_known_hosts_file }}"
  with_items: groups['guests']

- name: collect the current username
  local_action: command whoami
  sudo: no
  register: local_username

- name: set the proper permissions back on known_hosts
  file: path={{ ssh_known_hosts_file }}
        owner={{ local_username.stdout }}
        group={{ local_username.stdout }}
        mode=0600
